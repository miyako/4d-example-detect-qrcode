<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
                <title>DEMO</title>
                <link href="/css/bootstrap.min.css" rel="stylesheet" />
            </head>
    <body>
        <div class="col-auto">
            <label for="fileInput" class="visually-hidden"></label>
            <input class="form-control" id="fileInput" type="file" accept="image/*;capture=camera" />
        </div>
        <div class="col-auto">
            <label for="textValue" class="visually-hidden"></label>
            <input type="text" class="form-control" id="textValue" disabled />
        </div>
        <button id="send" type="button" class="btn btn-primary disabled">Send</button>
        <script src="/js/jquery.js"></script>
        <script>
            var app = (function($){
                const credentials = {
                    username:'guest',
                    password:'tseug'
                };
                const headers = {
                    'username-4D':credentials.username,
                    'password-4D':credentials.password
                };
                var app = {
                    login:function(){
                        // Make a request for a user with a given ID
                        axios.post('/rest/$directory/login', {}, {headers:headers})
                        .then(function (response) {
                            console.log(response);
                        })
                        .catch(function (error) {
                            console.log(error);
                        })
                        .finally(function () {
                            // always executed
                        });
                    },
                    send:function(value){
                        axios.post('/rest/$catalog/send', [value], {headers:headers})
                        .then(function (response) {
                            $("#textValue").val(response.data.result.message);
                            console.log(response);
                            app.logout();
                        })
                        .catch(function (error) {
                            console.log(error);
                        })
                        .finally(function () {
                            // always executed
                        });
                    },
                    logout:function(){
                        axios.post('/rest/$catalog/logout', null, {headers:headers})
                        .then(function (response) {
                            console.log(response);
                        })
                        .catch(function (error) {
                            console.log(error);
                        })
                        .finally(function () {
                            //
                        });
                    },
                    scan:function() {
                        const detector = new BarcodeDetector({ formats: ['qr_code'] });
                    }
                };
                $("#send").on('click', function(e){
                    app.send($("#textValue").val());
                });
                
                $("#fileInput").on('change', function(e){
                    
                    $("#textValue").val("");
                    
                    if(this.files.length != 0) {
                        let source = this.files[0];
                        const detector = new BarcodeDetector({ formats: ['qr_code']});
                        detector.detect(source)
                        .then(function (response) {
                            if(response.length > 0){
                                $("#textValue").val(response[0].rawValue);
                                $("#send").removeClass("disabled");
                            }else{
                                $("#textValue").val("barcode not detected");
                                $("#send").addClass("disabled");
                            }
                        })
                        .catch(function (error) {
                            $("#textValue").val("ERROR");
                            $("#send").addClass("disabled");
                        })
                        .finally(function () {
                            //
                        });
                    }
                    
                });
                
                return app;
            })(jQuery);
        </script>
        <script src="/js/bootstrap.min.js"></script>
        <script src="/js/axios.min.js"></script>
        <script src="/js/zbar-wasm.js"></script>
        <script src="/js/barcode-detector-polyfill.js"></script>
        <script>
            try {
                window['BarcodeDetector'].getSupportedFormats()
            } catch {
                window['BarcodeDetector'] = barcodeDetectorPolyfill.BarcodeDetectorPolyfill
            }
        </script>
    </body>
</html>
